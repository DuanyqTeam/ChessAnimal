{"version":3,"sources":["../../../../../assets/common/script/assets/common/script/uiMatching.js"],"names":["uiPanel","require","mvs","GLB","cc","Class","properties","onLoad","_super","isRoomOwner","playerIcons","playerModel","nodeDict","active","i","MAX_PLAYER_COUNT","playerTemp","instantiate","addChild","position","v2","push","on","leaveRoom","clientEvent","eventType","joinRoomResponse","joinRoomNotify","leaveRoomResponse","leaveRoomNotify","joinOverResponse","joinRandomRoom","result","matchType","RANDOM_MATCH","engine","console","log","PROPERTY_MATCH","matchinfo","MatchInfo","maxPlayer","mode","canWatch","tags","tagsInfo","joinRoomWithProperties","startGame","director","loadScene","data","status","roomInfo","roomID","roomId","userIds","userInfo","id","playerIcon","j","roomUserInfoList","length","getComponent","setData","userId","playerUserIds","joinOver","JSON","stringify","roomUserInfo","leaveRoomInfo","playerId","init","leaveRoomRsp","uiFunc","closeUI","node","name","destroy","joinOverRsp","notifyGameStart","msg","action","GAME_START_EVENT","Game","GameManager","sendEventEx","onDestroy","off"],"mappings":"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","sourceRoot":"../../../../../assets/common/script","sourcesContent":["var uiPanel = require(\"uiPanel\");\nvar mvs = require(\"Matchvs\");\nvar GLB = require(\"Glb\");\ncc.Class({\n    extends: uiPanel,\n    properties: {},\n\n    onLoad() {\n        this._super();\n        GLB.isRoomOwner = false;\n        this.playerIcons = [];\n        this.playerModel = this.nodeDict[\"playerIcon\"];\n        this.playerModel.active = false;\n        for (var i = 0; i < GLB.MAX_PLAYER_COUNT; i++) {\n            var playerTemp = cc.instantiate(this.playerModel);\n            playerTemp.active = true;\n            this.nodeDict[\"playerLayout\"].addChild(playerTemp);\n            playerTemp.position = cc.v2(0, 0);\n            this.playerIcons.push(playerTemp);\n        }\n\n        this.nodeDict[\"quit\"].on(\"click\", this.leaveRoom, this);\n\n        clientEvent.on(clientEvent.eventType.joinRoomResponse, this.joinRoomResponse, this);\n        clientEvent.on(clientEvent.eventType.joinRoomNotify, this.joinRoomNotify, this);\n        clientEvent.on(clientEvent.eventType.leaveRoomResponse, this.leaveRoomResponse, this);\n        clientEvent.on(clientEvent.eventType.leaveRoomNotify, this.leaveRoomNotify, this);\n        clientEvent.on(clientEvent.eventType.joinOverResponse, this.joinOverResponse, this);\n    },\n\n    joinRandomRoom: function() {\n        var result = null;\n        if (GLB.matchType === GLB.RANDOM_MATCH) {\n            result = mvs.engine.joinRandomRoom(GLB.MAX_PLAYER_COUNT, '');\n            if (result !== 0) {\n                console.log('进入房间失败,错误码:' + result);\n            }\n        } else if (GLB.matchType === GLB.PROPERTY_MATCH) {\n            var matchinfo = new mvs.MatchInfo();\n            matchinfo.maxPlayer = GLB.MAX_PLAYER_COUNT;\n            matchinfo.mode = 0;\n            matchinfo.canWatch = 0;\n            matchinfo.tags = GLB.tagsInfo;\n            result = mvs.engine.joinRoomWithProperties(matchinfo, \"joinRoomWithProperties\");\n            if (result !== 0) {\n                console.log('进入房间失败,错误码:' + result);\n            }\n        }\n    },\n\n    startGame: function() {\n        console.log('游戏即将开始');\n        cc.director.loadScene('game');\n    },\n\n    joinRoomResponse: function(data) {\n        if (data.status !== 200) {\n            console.log('进入房间失败,异步回调错误码: ' + data.status);\n        } else {\n            console.log('进入房间成功');\n            console.log('房间号: ' + data.roomInfo.roomID);\n        }\n        GLB.roomId = data.roomInfo.roomID;\n        var userIds = [GLB.userInfo.id]\n        console.log('房间用户: ' + userIds);\n\n        var playerIcon = null;\n        for (var j = 0; j < data.roomUserInfoList.length; j++) {\n            playerIcon = this.playerIcons[j].getComponent('playerIcon');\n            if (playerIcon && !playerIcon.userInfo) {\n                playerIcon.setData(data.roomUserInfoList[j]);\n                if (GLB.userInfo.id !== data.roomUserInfoList[j].userId) {\n                    userIds.push(data.roomUserInfoList[j].userId);\n                }\n            }\n        }\n\n        for (var i = 0; i < this.playerIcons.length; i++) {\n            playerIcon = this.playerIcons[i].getComponent('playerIcon');\n            if (playerIcon && !playerIcon.userInfo) {\n                playerIcon.setData(GLB.userInfo);\n                break;\n            }\n        }\n        GLB.playerUserIds = userIds;\n        if (userIds.length >= GLB.MAX_PLAYER_COUNT) {\n            var result = mvs.engine.joinOver(\"\");\n            console.log(\"发出关闭房间的通知\");\n            if (result !== 0) {\n                console.log(\"关闭房间失败，错误码：\", result);\n            }\n\n            GLB.playerUserIds = userIds;\n        }\n    },\n\n    joinRoomNotify: function(data) {\n        console.log(\"joinRoomNotify, roomUserInfo:\" + JSON.stringify(data.roomUserInfo));\n        var playerIcon = null;\n        for (var j = 0; j < this.playerIcons.length; j++) {\n            playerIcon = this.playerIcons[j].getComponent('playerIcon');\n            if (playerIcon && !playerIcon.userInfo) {\n                playerIcon.setData(data.roomUserInfo);\n                break;\n            }\n        }\n    },\n\n    leaveRoom: function() {\n        mvs.engine.leaveRoom(\"\");\n    },\n\n    leaveRoomNotify: function(data) {\n        if (GLB.roomId === data.leaveRoomInfo.roomID) {\n            for (var i = 0; i < this.playerIcons.length; i++) {\n                var playerIcon = this.playerIcons[i].getComponent('playerIcon');\n                if (playerIcon && playerIcon.userInfo && playerIcon.playerId === data.leaveRoomInfo.userId) {\n                    playerIcon.init();\n                    break;\n                }\n            }\n        }\n    },\n\n    leaveRoomResponse: function(data) {\n        if (data.leaveRoomRsp.status === 200) {\n            console.log(\"离开房间成功\");\n            for (var i = 0; i < this.playerIcons.length; i++) {\n                var playerIcon = this.playerIcons[i].getComponent('playerIcon');\n                if (playerIcon) {\n                    playerIcon.init();\n                    break;\n                }\n            }\n            uiFunc.closeUI(this.node.name);\n            this.node.destroy();\n        } else {\n            console.log(\"离开房间失败\");\n        }\n    },\n\n\n    joinOverResponse: function(data) {\n        if (data.joinOverRsp.status === 200) {\n            console.log(\"关闭房间成功\");\n            this.notifyGameStart();\n        } else {\n            console.log(\"关闭房间失败，回调通知错误码：\", data.joinOverRsp.status);\n        }\n    },\n\n    notifyGameStart: function() {\n        GLB.isRoomOwner = true;\n        var msg = {\n            action: GLB.GAME_START_EVENT,\n            userIds: GLB.playerUserIds\n        };\n        Game.GameManager.sendEventEx(msg);\n    },\n\n    onDestroy: function() {\n        clientEvent.off(clientEvent.eventType.joinRoomResponse, this.joinRoomResponse, this);\n        clientEvent.off(clientEvent.eventType.joinRoomNotify, this.joinRoomNotify, this);\n        clientEvent.off(clientEvent.eventType.leaveRoomResponse, this.leaveRoomResponse, this);\n        clientEvent.off(clientEvent.eventType.leaveRoomNotify, this.leaveRoomNotify, this);\n    }\n});\n"]}